<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Quiz Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
            font-family: sans-serif;
            font-weight: 100;
            font-size: 36pt;
        }

        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            color: #000000;
        }

        input {
            width: 80vw;
            background-color: #cccccc;
            color: #000000;
            border: none;
            outline: none;
            margin-top: 24px;
            padding: 8px;
        }

        button {
            display: block;
        }

        .main {
            display: block;
        }

        .won {
            display: none;
        }
    </style>
</head>

<body>
    <button>Highscore</button>
    <div class="main">
        <p></p>
        <input>
    </div>
    <div class="won">
        Congratulations ! You have won !
    </div>

    <script>
        (async () => {
            const $main = document.querySelector('.main');
            const $riddle = document.querySelector('p');
            const $input = document.querySelector('input');
            const $won = document.querySelector('.won');
            const $score = document.querySelector('button');

            // Start Game
            if (!sessionStorage.getItem('gameId')) {
                const response = await fetch('/start-game', {
                    method: 'POST'
                });
                const { gameId } = await response.json();
                sessionStorage.setItem('gameId', gameId);
            }
            const gameId = sessionStorage.getItem('gameId');

            // Get highscore
            $score.addEventListener('click', async () => {
                const response = await fetch('/highscore');
                const { highscore } = await response.json();
                alert("Highscore: " + highscore);
            })

            // Get question
            const response = await fetch('/current-state/' + gameId);
            const { isWon, riddle } = await response.json();
            if (isWon) {
                $main.style.display = 'none';
                $won.style.display = 'block';
                return;
            }
            $riddle.innerText = riddle;

            // Send answer
            $input.addEventListener('change', async () => {
                const guess = $input.value;
                const response = await fetch('/make-guess/' + gameId, {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({ guess })
                });
                const wasCorrect = response.status === 200;
                if (wasCorrect) {
                    $input.value = '';
                    const response = await fetch('/current-state/' + gameId);
                    const { isWon, riddle } = await response.json();
                    if (isWon) {
                        $main.style.display = 'none';
                        $won.style.display = 'block';
                        return;
                    }
                    $riddle.innerText = riddle;
                }
            });

            $input.focus();
        })();
    </script>
</body>

</html>